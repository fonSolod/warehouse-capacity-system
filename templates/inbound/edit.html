{% extends "base.html" %}
{% block title %}–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ{% endblock %}
{% block content %}
<h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ (A1.1)</h2>

<form method="post" id="inboundForm">
    <label>–ö–ª–∏–µ–Ω—Ç*:
        <select name="client_id" required onchange="loadProducts(this.value)">
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî</option>
            {% for c in clients %}
                <option value="{{ c[0] }}">{{ c[1] }}</option>
            {% endfor %}
        </select>
    </label>

    <label>–ù–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞*:
        <input type="text" name="doc_number" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–ê–ö-2025-001">
    </label>

    <label>–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞*:
        <input type="date" name="doc_date" required>
    </label>

    <h3>–ü–æ–∑–∏—Ü–∏–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</h3>
    <div id="items">
        <!-- –ü–µ—Ä–≤–∞—è –ø–æ–∑–∏—Ü–∏—è -->
        <div class="item-row" style="display:flex; gap:10px; margin-bottom:10px; align-items:end;">
            <select name="sku_id" required style="flex:2;">
                <option value="">‚Äî –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî</option>
            </select>
            <input type="number" step="0.001" name="qty" min="0.001" placeholder="–ö–æ–ª-–≤–æ" required style="flex:1;">
            <select name="unit_type" required style="flex:1;">
                <option value="—à—Ç">—à—Ç</option>
                <option value="–∫–æ—Ä–æ–±–∫–∞">–∫–æ—Ä–æ–±–∫–∞</option>
                <option value="–ø–∞–ª–ª–µ—Ç–∞">–ø–∞–ª–ª–µ—Ç–∞</option>
            </select>
            <button type="button" onclick="removeItem(this)" style="padding:5px;">üóëÔ∏è</button>
        </div>
    </div>

    <button type="button" onclick="addItem()" style="margin:10px 0;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
    <br>
    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button>
    <a href="{{ url_for('inbound_list') }}" class="btn">–û—Ç–º–µ–Ω–∞</a>
</form>

<script>
// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã (–¥–ª—è –∫—É—Ä—Å–æ–≤–æ–≥–æ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
const allProducts = {{ products | tojson }};
const clients = {{ clients | tojson }};

function loadProducts(clientId) {
    if (!clientId) {
        // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –æ—á–∏—â–∞–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
        document.querySelectorAll('#items select[name="sku_id"]').forEach(select => {
            select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî</option>';
        });
        return;
    }

    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É
    const filtered = allProducts.filter(p => p[1] == clientId); // p[1] = client_id –≤ products

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏
    let optionsHtml = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä ‚Äî</option>';
    filtered.forEach(p => {
        optionsHtml += `<option value="${p[0]}">${p[2]}</option>`; // p[0]=sku_id, p[2]=name
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å–µ–ª–µ–∫—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    document.querySelectorAll('#items select[name="sku_id"]').forEach(select => {
        select.innerHTML = optionsHtml;
    });
}

function addItem() {
    const itemsDiv = document.getElementById('items');
    const newRow = document.createElement('div');
    newRow.className = 'item-row';
    newRow.style.display = 'flex';
    newRow.style.gap = '10px';
    newRow.style.marginBottom = '10px';
    newRow.style.alignItems = 'end';

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
    const clientId = document.querySelector('select[name="client_id"]').value;

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    let productOptions = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä ‚Äî</option>';
    if (clientId) {
        const filtered = allProducts.filter(p => p[1] == clientId);
        filtered.forEach(p => {
            productOptions += `<option value="${p[0]}">${p[2]}</option>`;
        });
    } else {
        productOptions = '<option value="">‚Äî –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî</option>';
    }

    newRow.innerHTML = `
        <select name="sku_id" required style="flex:2;">
            ${productOptions}
        </select>
        <input type="number" step="0.001" name="qty" placeholder="–ö–æ–ª-–≤–æ" required style="flex:1;">
        <select name="unit_type" required style="flex:1;">
            <option value="—à—Ç">—à—Ç</option>
            <option value="–∫–æ—Ä–æ–±–∫–∞">–∫–æ—Ä–æ–±–∫–∞</option>
            <option value="–ø–∞–ª–ª–µ—Ç–∞">–ø–∞–ª–ª–µ—Ç–∞</option>
        </select>
        <button type="button" onclick="removeItem(this)" style="padding:5px;">üóëÔ∏è</button>
    `;
    itemsDiv.appendChild(newRow);
}

function removeItem(button) {
    if (document.querySelectorAll('#items .item-row').length > 1) {
        button.closest('.item-row').remove();
    } else {
        alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é.');
    }
}

// === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
document.addEventListener('DOMContentLoaded', function () {
    const clientSelect = document.querySelector('select[name="client_id"]');
    if (clientSelect && clientSelect.value) {
        // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –≤—ã–±—Ä–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏) ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ —Ç–æ–≤–∞—Ä—ã
        loadProducts(clientSelect.value);
    }
});
</script>
{% endblock %}